// ssd1306.c  (V2: font in PROGMEM to save SRAM)
#ifndef F_CPU
#define F_CPU 3333333UL
#endif

#include "ssd1306.h"
#include "ssd1306_hal.h"
#include <avr/pgmspace.h>
#include <stdbool.h>
#include <stdint.h>

#if SSD1306_BUFFERED
static uint8_t g_fb[SSD1306_WIDTH * (SSD1306_HEIGHT/8)];
#endif

// --- small 5x7 font (ASCII 32..127) stored in FLASH ---
static const uint8_t font5x7[96][5] PROGMEM = {
  {0x00,0x00,0x00,0x00,0x00},{0x00,0x00,0x5F,0x00,0x00},{0x00,0x07,0x00,0x07,0x00},{0x14,0x7F,0x14,0x7F,0x14},{0x24,0x2A,0x7F,0x2A,0x12},{0x23,0x13,0x08,0x64,0x62},{0x36,0x49,0x55,0x22,0x50},{0x00,0x05,0x03,0x00,0x00},
  {0x00,0x1C,0x22,0x41,0x00},{0x00,0x41,0x22,0x1C,0x00},{0x14,0x08,0x3E,0x08,0x14},{0x08,0x08,0x3E,0x08,0x08},{0x00,0x50,0x30,0x00,0x00},{0x08,0x08,0x08,0x08,0x08},{0x00,0x60,0x60,0x00,0x00},{0x20,0x10,0x08,0x04,0x02},
  {0x3E,0x51,0x49,0x45,0x3E},{0x00,0x42,0x7F,0x40,0x00},{0x42,0x61,0x51,0x49,0x46},{0x21,0x41,0x45,0x4B,0x31},{0x18,0x14,0x12,0x7F,0x10},{0x27,0x45,0x45,0x45,0x39},{0x3C,0x4A,0x49,0x49,0x30},{0x01,0x71,0x09,0x05,0x03},
  {0x36,0x49,0x49,0x49,0x36},{0x06,0x49,0x49,0x29,0x1E},{0x00,0x36,0x36,0x00,0x00},{0x00,0x56,0x36,0x00,0x00},{0x00,0x08,0x14,0x22,0x41},{0x14,0x14,0x14,0x14,0x14},{0x41,0x22,0x14,0x08,0x00},{0x02,0x01,0x51,0x09,0x06},
  {0x32,0x49,0x79,0x41,0x3E},{0x7E,0x11,0x11,0x11,0x7E},{0x7F,0x49,0x49,0x49,0x36},{0x3E,0x41,0x41,0x41,0x22},{0x7F,0x41,0x41,0x22,0x1C},{0x7F,0x49,0x49,0x49,0x41},{0x7F,0x09,0x09,0x09,0x01},{0x3E,0x41,0x49,0x49,0x7A},
  {0x7F,0x08,0x08,0x08,0x7F},{0x00,0x41,0x7F,0x41,0x00},{0x20,0x40,0x41,0x3F,0x01},{0x7F,0x08,0x14,0x22,0x41},{0x7F,0x40,0x40,0x40,0x40},{0x7F,0x02,0x0C,0x02,0x7F},{0x7F,0x04,0x08,0x10,0x7F},{0x3E,0x41,0x41,0x41,0x3E},
  {0x7F,0x09,0x09,0x09,0x06},{0x3E,0x41,0x51,0x21,0x5E},{0x7F,0x09,0x19,0x29,0x46},{0x46,0x49,0x49,0x49,0x31},{0x01,0x01,0x7F,0x01,0x01},{0x3F,0x40,0x40,0x40,0x3F},{0x1F,0x20,0x40,0x20,0x1F},{0x3F,0x40,0x38,0x40,0x3F},
  {0x63,0x14,0x08,0x14,0x63},{0x07,0x08,0x70,0x08,0x07},{0x61,0x51,0x49,0x45,0x43},{0x00,0x7F,0x41,0x41,0x00},{0x02,0x04,0x08,0x10,0x20},{0x00,0x41,0x41,0x7F,0x00},{0x04,0x02,0x01,0x02,0x04},{0x40,0x40,0x40,0x40,0x40},
  {0x00,0x01,0x02,0x00,0x00},{0x20,0x54,0x54,0x54,0x78},{0x7F,0x48,0x44,0x44,0x38},{0x38,0x44,0x44,0x44,0x20},{0x38,0x44,0x44,0x48,0x7F},{0x38,0x54,0x54,0x54,0x18},{0x08,0x7E,0x09,0x01,0x02},{0x0C,0x52,0x52,0x52,0x3E},
  {0x7F,0x08,0x04,0x04,0x78},{0x00,0x44,0x7D,0x40,0x00},{0x20,0x40,0x44,0x3D,0x00},{0x7F,0x10,0x28,0x44,0x00},{0x00,0x41,0x7F,0x40,0x00},{0x7C,0x04,0x18,0x04,0x78},{0x7C,0x08,0x04,0x04,0x78},{0x38,0x44,0x44,0x44,0x38},
  {0x7E,0x12,0x12,0x12,0x0C},{0x0C,0x12,0x12,0x12,0x7E},{0x7C,0x08,0x04,0x04,0x08},{0x48,0x54,0x54,0x54,0x20},{0x04,0x3F,0x44,0x40,0x20},{0x3C,0x40,0x40,0x20,0x7C},{0x1C,0x20,0x40,0x20,0x1C},{0x3C,0x40,0x30,0x40,0x3C},
  {0x44,0x28,0x10,0x28,0x44},{0x0C,0x50,0x50,0x50,0x3C},{0x44,0x64,0x54,0x4C,0x44},{0x00,0x08,0x36,0x41,0x00},{0x00,0x00,0x7F,0x00,0x00},{0x00,0x41,0x36,0x08,0x00},{0x08,0x04,0x08,0x10,0x08},{0x00,0x00,0x00,0x00,0x00}
};

// --- low-level helpers
static inline bool cmd1(uint8_t c){ return ssd1306_hal_write_cmds(&c,1); }
static inline bool cmd2(uint8_t a,uint8_t b){ uint8_t v[2]={a,b}; return ssd1306_hal_write_cmds(v,2); }

// --- API impl
bool ssd1306_begin(void)
{
    if(!ssd1306_hal_init()) return false;
    ssd1306_hal_delay_ms(20);

    if(!cmd1(0xAE)) return false;                 // OFF
    if(!cmd2(0xD5,0x80)) return false;            // clock
    if(!cmd2(0xA8, SSD1306_HEIGHT-1)) return false; // mux
    if(!cmd2(0xD3,0x00)) return false;            // offset
    if(!cmd1(0x40)) return false;                 // start line = 0
    if(!cmd1(0xA1)) return false;                 // seg remap (swap to 0xA0 if mirrored)
    if(!cmd1(0xC8)) return false;                 // com scan (swap to 0xC0 if upside-down)
    if(!cmd2(0xDA, (SSD1306_HEIGHT==64)?0x12:0x02)) return false; // com pins
    if(!cmd2(0x81,0x7F)) return false;            // contrast
    if(!cmd2(0xD9,0xF1)) return false;            // precharge
    if(!cmd2(0xDB,0x40)) return false;            // vcomh
    if(!cmd1(0xA4)) return false;                 // resume
    if(!cmd1(0xA6)) return false;                 // normal
    if(!cmd1(0x20)) return false;                 // memory mode
    if(!cmd1(0x02)) return false;                 // page addressing
#if SSD1306_USE_CHARGEPUMP
    if(!cmd1(0x8D)) return false;                 // charge pump
    if(!cmd1(0x14)) return false;                 //   on  (0x10 for external VCC)
#endif
    if(!cmd1(0x2E)) return false;                 // scroll off
    if(!cmd1(0xAF)) return false;                 // ON

    ssd1306_clear();
    ssd1306_display();
    return true;
}

void ssd1306_set_contrast(uint8_t v){ cmd2(0x81,v); }
void ssd1306_invert(bool on){ cmd1(on?0xA7:0xA6); }

static inline void set_page_col(uint8_t page, uint8_t col){
    uint8_t c[3]={ (uint8_t)(0xB0 | (page & 7)),
                   (uint8_t)(0x00 | (col & 0x0F)),
                   (uint8_t)(0x10 | ((col>>4)&0x0F)) };
    (void)ssd1306_hal_write_cmds(c,3);
}

void ssd1306_clear(void)
{
#if SSD1306_BUFFERED
    for(uint16_t i=0;i<sizeof(g_fb);++i) g_fb[i]=0;
#else
    for(uint8_t p=0;p<(SSD1306_HEIGHT/8);++p){
        set_page_col(p,0);
        static uint8_t line[SSD1306_WIDTH]; // static = no big stack usage
        for(uint8_t i=0;i<SSD1306_WIDTH;i++) line[i]=0x00;
        (void)ssd1306_hal_write_data(line, SSD1306_WIDTH);
    }
#endif
}

void ssd1306_display(void)
{
#if SSD1306_BUFFERED
    for(uint8_t p=0;p<(SSD1306_HEIGHT/8);++p){
        set_page_col(p,0);
        (void)ssd1306_hal_write_data(&g_fb[p*SSD1306_WIDTH], SSD1306_WIDTH);
    }
#endif
}

static inline void fb_plot(uint8_t x,uint8_t y,bool on){
#if SSD1306_BUFFERED
    if(x>=SSD1306_WIDTH || y>=SSD1306_HEIGHT) return;
    uint16_t idx = (y>>3)*SSD1306_WIDTH + x;
    uint8_t  mask = (uint8_t)(1u << (y & 7));
    if(on) g_fb[idx] |= mask; else g_fb[idx] &= (uint8_t)~mask;
#else
    if(x>=SSD1306_WIDTH || y>=SSD1306_HEIGHT) return;
    set_page_col((uint8_t)(y>>3), x);
    uint8_t b = (uint8_t)(1u << (y & 7));
    (void)ssd1306_hal_write_data(&b,1);
#endif
}

void ssd1306_draw_pixel(uint8_t x,uint8_t y,bool on){ fb_plot(x,y,on); }

void ssd1306_draw_hline(uint8_t x,uint8_t y,uint8_t w,bool on){
    if(y>=SSD1306_HEIGHT || x>=SSD1306_WIDTH) return;
    uint16_t x2 = (uint16_t)x + w;
    if(x2 > SSD1306_WIDTH) x2 = SSD1306_WIDTH;
    for(uint16_t i=x;i<x2;i++) fb_plot((uint8_t)i,y,on);
}

void ssd1306_draw_vline(uint8_t x,uint8_t y,uint8_t h,bool on){
    if(x>=SSD1306_WIDTH || y>=SSD1306_HEIGHT) return;
    uint16_t y2 = (uint16_t)y + h;
    if(y2 > SSD1306_HEIGHT) y2 = SSD1306_HEIGHT;
    for(uint16_t j=y;j<y2;j++) fb_plot(x,(uint8_t)j,on);
}

void ssd1306_draw_rect(uint8_t x,uint8_t y,uint8_t w,uint8_t h,bool on){
    if(!w||!h) return;
    ssd1306_draw_hline(x,y,w,on);
    ssd1306_draw_hline(x,(uint8_t)(y+h-1),w,on);
    ssd1306_draw_vline(x,y,h,on);
    ssd1306_draw_vline((uint8_t)(x+w-1),y,h,on);
}

void ssd1306_fill_rect(uint8_t x,uint8_t y,uint8_t w,uint8_t h,bool on){
    for(uint8_t j=0;j<h;j++) ssd1306_draw_hline(x,(uint8_t)(y+j),w,on);
}

static uint8_t cursor_col=0, cursor_page=0;
void ssd1306_set_cursor(uint8_t col,uint8_t page){ cursor_col=col; cursor_page=page; }

void ssd1306_write_char(char c)
{
    if(c < 32 || c > 127) c = '?';

#if SSD1306_BUFFERED
    if(cursor_page >= (SSD1306_HEIGHT/8)) return;
    for(uint8_t i=0;i<5;i++){
        uint8_t colBits = pgm_read_byte(&font5x7[(uint8_t)c - 32][i]);
        for(uint8_t bit=0; bit<8; bit++){
            bool on = ((colBits >> bit) & 1u) != 0;
            if(cursor_col < SSD1306_WIDTH)
                fb_plot(cursor_col, (uint8_t)(cursor_page*8 + bit), on);
        }
        cursor_col++;
    }
    // 1-col space
    for(uint8_t bit=0; bit<8; bit++){
        if(cursor_col < SSD1306_WIDTH)
            fb_plot(cursor_col, (uint8_t)(cursor_page*8 + bit), false);
    }
    cursor_col++;
#else
    // streamed: set address and push 5 glyph columns from PROGMEM + 1 space
    set_page_col(cursor_page, cursor_col);
    uint8_t tmp[6];
    tmp[0] = pgm_read_byte(&font5x7[(uint8_t)c - 32][0]);
    tmp[1] = pgm_read_byte(&font5x7[(uint8_t)c - 32][1]);
    tmp[2] = pgm_read_byte(&font5x7[(uint8_t)c - 32][2]);
    tmp[3] = pgm_read_byte(&font5x7[(uint8_t)c - 32][3]);
    tmp[4] = pgm_read_byte(&font5x7[(uint8_t)c - 32][4]);
    tmp[5] = 0x00; // spacing
    (void)ssd1306_hal_write_data(tmp,6);
    cursor_col = (uint8_t)(cursor_col + 6);
#endif
}

void ssd1306_write_string(const char *s){ while(*s) ssd1306_write_char(*s++); }
void ssd1306_goto(uint8_t col, uint8_t page)
{
    // update both HW address and SW cursor
    cursor_col  = col;
    cursor_page = page;
    // set OLED page/column (the static helper you already have)
    uint8_t c[3] = {
        (uint8_t)(0xB0 | (page & 7)),
        (uint8_t)(0x00 | (col & 0x0F)),
        (uint8_t)(0x10 | ((col >> 4) & 0x0F))
    };
    (void)ssd1306_hal_write_cmds(c, 3);
}
static void _write_rev(char *p, uint8_t n){
    // write n chars in reverse order using ssd1306_write_char
    while(n--) ssd1306_write_char(*p--);
}

void ssd1306_write_u16(uint16_t v){
    // convert to decimal without printf
    if (v == 0) { ssd1306_write_char('0'); return; }
    char buf[5]; uint8_t n=0;
    while(v){ buf[n++] = (char)('0' + (v % 10)); v /= 10; }
    _write_rev(&buf[n-1], n);
}

void ssd1306_write_s16(int16_t v){
    if (v < 0) { ssd1306_write_char('-'); v = (int16_t)(-v); }
    ssd1306_write_u16((uint16_t)v);
}

void ssd1306_write_hex8(uint8_t v){
    const char *hex="0123456789ABCDEF";
    ssd1306_write_char(hex[(v>>4)&0xF]);
    ssd1306_write_char(hex[v&0xF]);
}

void ssd1306_write_fixed2(int16_t v_x100){
    // prints like 23.25 from 2325
    if (v_x100 < 0) { ssd1306_write_char('-'); v_x100 = (int16_t)(-v_x100); }
    uint16_t i = (uint16_t)(v_x100/100);
    uint8_t  d = (uint8_t)(v_x100%100);
    ssd1306_write_u16(i);
    ssd1306_write_char('.');
    ssd1306_write_char((char)('0' + d/10));
    ssd1306_write_char((char)('0' + d%10));
}
